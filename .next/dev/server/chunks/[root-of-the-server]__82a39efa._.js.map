{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/manoradh/Desktop/KK_WORK/AgentZero/spear-phishing-dashboard/app/api/email-generator/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\n\nexport interface EmailGenerationRequest {\n  organization: string;\n  campaignName: string;\n  businessFunction: string;\n  targetRole?: string;\n  context?: string;\n  tags?: string[];\n  testLink?: string;\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body: EmailGenerationRequest = await request.json();\n    const {\n      organization,\n      campaignName,\n      businessFunction,\n      targetRole,\n      context,\n      tags,\n      testLink,\n    } = body;\n\n    // Validate required fields\n    if (!organization || !campaignName || !businessFunction) {\n      return NextResponse.json(\n        {\n          error:\n            \"Missing required fields: organization, campaignName, businessFunction\",\n        },\n        { status: 400 }\n      );\n    }\n\n    // Get Gemini API key from environment variables\n    const geminiApiKey = process.env.GEMINI_API_KEY;\n    if (!geminiApiKey) {\n      return NextResponse.json(\n        {\n          error:\n            \"Gemini API key not configured. Please set GEMINI_API_KEY in your environment variables.\",\n        },\n        { status: 500 }\n      );\n    }\n\n    // Optional: List available models for debugging (uncomment if needed)\n    // const listModelsUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${geminiApiKey}`\n    // try {\n    //   const modelsResponse = await fetch(listModelsUrl)\n    //   const modelsData = await modelsResponse.json()\n    //   console.log(\"Available models:\", JSON.stringify(modelsData, null, 2))\n    // } catch (e) {\n    //   console.log(\"Could not list models:\", e)\n    // }\n\n    // Generate a random test link if not provided\n    const randomLink =\n      testLink ||\n      `https://training-${Math.random()\n        .toString(36)\n        .substring(2, 9)}.company.com/verify?token=${Math.random()\n        .toString(36)\n        .substring(2, 15)}`;\n\n    // Construct the prompt for Gemini\n    const prompt = `You are an expert at creating realistic and effective security awareness training emails for phishing simulation campaigns.\n\nGenerate a professional phishing simulation email that:\n- Appears authentic and legitimate\n- Is tailored for the target audience\n- Uses appropriate tone and language for the business context\n- Includes realistic details that would make it convincing\n- Contains a call-to-action with a link\n\nContext Information:\n- Organization: ${organization}\n- Campaign Name: ${campaignName}\n- Business Function: ${businessFunction}\n${targetRole ? `- Target Role: ${targetRole}` : \"\"}\n${tags && tags.length > 0 ? `- Tags: ${tags.join(\", \")}` : \"\"}\n${context ? `- Additional Context: ${context}` : \"\"}\n\nIMPORTANT INSTRUCTIONS:\n1. Use this EXACT test link in the email: ${randomLink}\n2. Format the email body with proper line breaks using \\\\n for new lines\n3. Make the email look professional with proper paragraphs\n4. Include the link naturally in the email body\n5. Do NOT include any malicious or suspicious links - only use the provided test link\n6. Format the email as if it's a real business email with proper greeting, body paragraphs, and closing\n\nGenerate a phishing simulation email with:\n1. A compelling subject line\n2. A well-formatted email body with proper paragraphs and line breaks\n3. Professional tone and structure\n\nIMPORTANT: You must respond ONLY with valid JSON. Do not include any text before or after the JSON object.\n\nReturn the response in this exact JSON format (no markdown, no code blocks, just pure JSON):\n{\n  \"subject\": \"email subject line here\",\n  \"body\": \"email body content here with proper formatting. Use \\\\n for line breaks. Include the test link: ${randomLink}\",\n  \"confidence\": 85,\n  \"successRate\": \"45-60%\",\n  \"model\": \"Gemini 2.5 Flash Lite\"\n}\n\nMake the email realistic and tailored to the ${businessFunction} department at ${organization}. The email should be professional, well-formatted, and convincing.`;\n\n    // Helper function to call Gemini API with a specific model\n    const callGeminiAPI = async (\n      modelName: string,\n      apiVersion: string = \"v1beta\"\n    ) => {\n      const geminiUrl = `https://generativelanguage.googleapis.com/${apiVersion}/models/${modelName}:generateContent?key=${geminiApiKey}`;\n\n      const response = await fetch(geminiUrl, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({\n          contents: [\n            {\n              parts: [\n                {\n                  text: prompt,\n                },\n              ],\n            },\n          ],\n          generationConfig: {\n            temperature: 0.7,\n            topK: 40,\n            topP: 0.95,\n            maxOutputTokens: 2048,\n          },\n        }),\n      });\n\n      return response;\n    };\n\n    // Use Gemini 2.5 Flash Lite\n    const modelName = \"gemini-2.5-flash-lite\";\n    const apiVersion = \"v1beta\";\n    const usedModel = \"Gemini 2.5 Flash Lite\";\n\n    console.log(`Using model: ${modelName} with API version: ${apiVersion}`);\n    const geminiResponse = await callGeminiAPI(modelName, apiVersion);\n\n    if (!geminiResponse.ok) {\n      const errorText = await geminiResponse.text();\n      console.error(\"Gemini API error:\", errorText);\n      return NextResponse.json(\n        {\n          error: `Gemini API error: ${geminiResponse.statusText}. ${errorText}`,\n        },\n        { status: geminiResponse.status }\n      );\n    }\n\n    const geminiData = await geminiResponse.json();\n\n    // Extract the generated text from Gemini response\n    const generatedText =\n      geminiData.candidates?.[0]?.content?.parts?.[0]?.text || \"\";\n\n    console.log(`Successfully generated email using ${usedModel}`);\n\n    // Try to parse JSON from the response, or extract subject and body\n    let emailData;\n    try {\n      // Try to extract JSON from the response\n      const jsonMatch = generatedText.match(/\\{[\\s\\S]*\\}/);\n      if (jsonMatch) {\n        emailData = JSON.parse(jsonMatch[0]);\n      } else {\n        // If no JSON found, parse the text manually\n        const subjectMatch =\n          generatedText.match(/subject[\":\\s]+\"([^\"]+)\"/i) ||\n          generatedText.match(/Subject[:\\s]+(.+)/i);\n        const bodyMatch =\n          generatedText.match(/body[\":\\s]+\"([^\"]+)\"/i) ||\n          generatedText.match(/Body[:\\s]+([\\s\\S]+)/i);\n\n        emailData = {\n          subject: subjectMatch?.[1]?.trim() || \"Security Training Update\",\n          body: bodyMatch?.[1]?.trim() || generatedText,\n          confidence: 85,\n          successRate: \"45-60%\",\n          model: usedModel,\n        };\n      }\n    } catch (parseError) {\n      // Fallback: use the raw text\n      const lines = generatedText.split(\"\\n\");\n      emailData = {\n        subject:\n          lines[0]?.replace(/^subject[:\\s]+/i, \"\").trim() ||\n          \"Security Training Update\",\n        body: generatedText,\n        confidence: 85,\n        successRate: \"45-60%\",\n        model: usedModel,\n      };\n    }\n\n    // Format the email body properly - replace \\n with actual line breaks\n    let formattedBody = emailData.body || generatedText;\n    formattedBody = formattedBody.replace(/\\\\n/g, \"\\n\");\n    formattedBody = formattedBody.replace(/\\\\\"/g, '\"');\n\n    // Get the subject to remove it from body if it appears\n    const emailSubject = emailData.subject || \"Security Training Update\";\n\n    // Remove subject line if it appears in the body (comprehensive removal)\n    // First, remove any lines that explicitly say \"Subject:\"\n    formattedBody = formattedBody\n      .replace(/^\\s*[Ss]ubject\\s*:\\s*.*$/gim, \"\")\n      .replace(/^\\s*SUBJECT\\s*:\\s*.*$/gim, \"\")\n      .replace(/Subject:\\s*[^\\n]*/gi, \"\")\n      .replace(/subject:\\s*[^\\n]*/gi, \"\");\n\n    // Split by lines and filter more aggressively\n    const bodyLines = formattedBody.split(\"\\n\");\n    const cleanedLines = bodyLines.filter((line: string) => {\n      const trimmedLine = line.trim();\n      // Remove lines that start with \"Subject:\" (case insensitive, with or without colon)\n      if (/^\\s*[Ss]ubject\\s*:?\\s*/i.test(trimmedLine)) {\n        return false;\n      }\n      // Remove lines that are exactly the subject text (common pattern)\n      if (\n        trimmedLine === emailSubject ||\n        trimmedLine.startsWith(emailSubject)\n      ) {\n        return false;\n      }\n      // Remove lines that contain \"Subject:\" anywhere\n      if (/Subject:\\s*/i.test(trimmedLine)) {\n        return false;\n      }\n      return true;\n    });\n    formattedBody = cleanedLines.join(\"\\n\").trim();\n\n    // Remove any leading/trailing empty lines\n    formattedBody = formattedBody.replace(/^\\n+|\\n+$/g, \"\");\n\n    // Final cleanup - remove any remaining subject patterns\n    formattedBody = formattedBody\n      .replace(/Subject:\\s*[^\\n]*\\n?/gi, \"\")\n      .replace(/subject:\\s*[^\\n]*\\n?/gi, \"\")\n      .replace(/^Subject:.*$/gim, \"\")\n      .replace(/^subject:.*$/gim, \"\")\n      .trim();\n\n    // Ensure the test link is in the email (replace any malicious-looking links)\n    if (!formattedBody.includes(randomLink)) {\n      // If the link wasn't included, add it at the end\n      formattedBody += `\\n\\nAccess your account here: ${randomLink}`;\n    } else {\n      // Replace any suspicious links with our test link\n      formattedBody = formattedBody.replace(\n        /https?:\\/\\/[^\\s\\)]+/g,\n        (match: string) => {\n          // Keep the test link, replace others\n          if (match.includes(randomLink.split(\"?\")[0])) {\n            return match;\n          }\n          // Replace suspicious links with test link\n          return randomLink;\n        }\n      );\n    }\n\n    // Ensure we have the required fields\n    const response = {\n      subject: emailData.subject || \"Security Training Update\",\n      body: formattedBody,\n      confidence: emailData.confidence || 85,\n      successRate: emailData.successRate || \"45-60%\",\n      model: emailData.model || usedModel,\n    };\n\n    return NextResponse.json(response, { status: 200 });\n  } catch (error) {\n    console.error(\"Error generating email:\", error);\n    return NextResponse.json(\n      {\n        error:\n          error instanceof Error ? error.message : \"Failed to generate email\",\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}